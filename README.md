# M3U8 批量下载器 🚀

这是一个功能强大且用户友好的 Python 脚本，旨在批量下载 `.m3u8` 视频链接，并将它们自动合并为 `.mp4` 文件。

脚本内置了环境检查、智能重命名、无限重试等多种高级功能，即使您是新手用户，也能轻松完成复杂的下载任务。

## ✨ 主要特性

*   **📺 批量处理**: 只需创建一个简单的 `.m3u` 文本文件，即可一次性处理成百上千个下载任务。
*   **🤖 智能环境检查**: 首次运行时自动检测 `FFmpeg` 和 Python 依赖库。如果缺失，会提供清晰、**一键式**的安装指导 (Windows 用户有惊喜！)。
*   **✍️ 智能重命名**: 自动处理文件名冲突。如果 `video.mp4` 已存在，新文件会自动命名为 `video001.mp4`, `video002.mp4`... 保证文件不会被覆盖。
*   **🔄 无限下载重试**: 针对网络波动导致的下载失败，脚本会以“指数退避”策略无限次重试，直到分片下载成功为止，极大提升下载成功率。
*   **⚡️ 高并发下载**: 支持多线程并发下载视频分片，充分利用您的网络带宽。
*   **📄 详细日志**: 所有操作和潜在错误都会被记录在 `download.log` 文件中，方便排查问题。
*   **🔗 自动解析**: 支持主播放列表（Master Playlist），能自动选择最高码率的视频流进行下载。

## ⚙️ 使用前准备

1.  **安装 Python**: 确保您的电脑上安装了 Python 3.6 或更高版本。
    *   访问 [Python 官网下载](https://www.python.org/downloads/)。
    *   **重要**: 在 Windows 安装时，请务必勾选 **"Add Python to PATH"** 选项。

2.  **下载脚本**: 将 `download_m3u8.py` 脚本文件下载到您的电脑上，例如放在 `D:\Downloads\M3U8_Downloader` 文件夹中。

## 📖 如何使用 (三步走)

### 第 1 步：创建下载任务列表

1. 在与 `download_m3u8.py` 脚本**相同的文件夹**下，创建一个新的文本文件。

2. 将这个文件重命名为任意 `.m3u` 结尾的文件，例如 `list.m3u`。

3. 用记事本或任何文本编辑器打开它，按照以下格式添加您想下载的视频链接：

   ```
   视频名称1,https://example.com/path/to/video1.m3u8
   视频名称2,https://example.com/path/to/video2.m3u8
   第三个视频,https://another.site/media/index.m3u8
   ```

   **格式说明**:

   *   每一行代表一个下载任务。
   *   `视频名称` 和 `URL` 之间用**英文逗号** `,` 分隔。
   *   `视频名称` 将作为最终输出的 `.mp4` 文件名（特殊字符会被自动处理）。如果名称留空，脚本会尝试从URL中生成一个。

### 第 2 步：运行下载脚本

1. 打开您的系统终端（命令行工具）：

   *   **Windows**: 按 `Win + R`，输入 `cmd` 或 `powershell`，然后回车。
   *   **macOS**: 打开“终端 (Terminal)”应用。
   *   **Linux**: 打开您常用的终端。

2. 使用 `cd` 命令切换到脚本所在的文件夹。例如：

   ```bash
   cd D:\Downloads\M3U8_Downloader
   ```

3. 运行脚本：

   ```bash
   python download_m3u8.py
   ```

### 第 3 步：首次运行与环境配置 (若需要)

* **如果您的环境已配置好**，脚本将直接开始下载，您会看到滚动的进度条。

* **如果这是您第一次运行**，脚本会自动检查环境并给出提示：

  1.  **缺少 Python 库?** 
      脚本会提示您缺少 `requests` 或 `tqdm`。只需复制它给出的命令 (如 `pip install requests tqdm`) 粘贴到终端里运行即可。
  2.  **缺少 FFmpeg?** (核心工具)
      *   **对于 Windows 用户 (强烈推荐)**: 脚本会提供一条**超长的 PowerShell 命令**。您只需打开 **PowerShell** (不是CMD)，**完整复制并粘贴**该命令后回车，它会自动帮您完成下载、解压和配置环境变量的全过程！
      *   **对于 macOS / Linux 用户**: 脚本会给出对应的 `brew` 或 `apt-get` / `dnf` 安装命令。

  **【极其重要】**: 在通过任何方式安装完 FFmpeg 后，请**务必关闭当前的终端窗口，然后重新打开一个新的终端窗口**，再回到第2步重新运行脚本。

### 🎉 完成！

下载完成后，所有 `.mp4` 视频文件都会保存在脚本目录下的 `video` 文件夹中。

## 🔧 高级配置 (可选)

您可以直接用文本编辑器打开 `download_m3u8.py` 脚本，在文件顶部的 **"配置"**区域修改以下参数：

| 参数名             | 默认值    | 说明                                                         |
| :----------------- | :-------- | :----------------------------------------------------------- |
| `OUTPUT_DIR`       | `'video'` | 最终视频文件的输出文件夹名称。                               |
| `TEMP_DIR`         | `'temp'`  | 下载视频分片时使用的临时文件夹。                             |
| `SOURCE_EXTENSION` | `'.m3u'`  | 脚本会自动扫描以该后缀结尾的任务列表文件。                   |
| `MAX_WORKERS`      | `32`      | 同时下载视频分片的最大线程数。网络好可以适当调高，网络差或服务器限制则需调低。 |

## ❓ 常见问题 (FAQ)

1.  **安装完 FFmpeg 后，脚本仍然提示 "未找到"？**
    *   这 99% 是因为您没有**重新打开一个新的终端窗口**。环境变量的更新需要新开一个会话才能生效。

2.  **下载速度很慢怎么办？**
    *   速度取决于您的网络带宽和视频源服务器的限制。您可以尝试修改 `MAX_WORKERS` 参数。但请注意，过高的并发数可能被服务器拒绝访问。

3.  **某个视频下载失败了怎么办？**
    *   首先检查 `download.log` 文件，查看详细的错误信息。
    *   可能是链接已失效，或该视频有特殊的加密方式（本脚本支持标准的 AES-128 加密）。

4.  **Windows 的自动安装命令执行失败了？**
    *   请确保您是在 `PowerShell` 中执行的，而不是 `CMD`。
    *   检查您的网络是否可以正常访问 FFmpeg 的下载服务器。
    *   如果仍然失败，您总是可以按照脚本提示的“方法2”进行手动安装。

---
